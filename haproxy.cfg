global
    maxconn 500000      # Maximum connections HAProxy can handle
    nbthread 4          # Number of threads (adjust based on your VMâ€™s cores)
    log stdout format raw local0

defaults
    mode http
    timeout connect 10s
    timeout client 60s
    timeout server 60s
    timeout queue 60s
    log global
    option httplog

frontend http_front
    bind *:80
    maxconn 500000
    default_backend nginx_servers

backend nginx_servers
    mode http
    balance leastconn                # Distribute requests to the least busy server
    cookie SRV insert indirect nocache
    option httpchk GET /health
    http-check expect status 200
    timeout check 5s
    timeout connect 5s
    timeout server 60s
    timeout queue 120s

    option redispatch  
    retries 3  

    # List each Nginx replica. Note: HAProxy will contact the containers on their internal port 8080.
    server nginx1 nginx_1:8080 check inter 5s rise 3 fall 10 maxconn 200000 cookie nginx1
    server nginx2 nginx_2:8080 check inter 5s rise 3 fall 10 maxconn 200000 cookie nginx2
    server nginx3 nginx_3:8080 check inter 5s rise 3 fall 10 maxconn 200000 cookie nginx3
    server nginx4 nginx_4:8080 check inter 5s rise 3 fall 10 maxconn 200000 cookie nginx4
